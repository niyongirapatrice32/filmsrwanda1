from flask import Flask, render_template_string, request, redirect, url_for
import sqlite3
from threading import Thread

# Initialize Flask app
app = Flask(__name__)

# HTML templates
home_template = """
<!doctype html>
<title>Mini Shop</title>
<h1>Welcome to Mini Shop</h1>
<a href="/products">View Products</a> | <a href="/add">Add Product</a>
"""

products_template = """
<!doctype html>
<title>Products</title>
<h1>Available Products</h1>
<ul>
  {% for product in products %}
    <li>
      <b>{{ product[1] }}</b> - ${{ product[2] }}
      [<a href="/buy/{{ product[0] }}">Buy</a>]
    </li>
  {% endfor %}
</ul>
<a href="/">Home</a>
"""

add_template = """
<!doctype html>
<title>Add Product</title>
<h1>Add a New Product</h1>
<form method="post">
  Name: <input type="text" name="name"><br>
  Price: <input type="number" name="price"><br>
  <input type="submit" value="Add">
</form>
<a href="/">Home</a>
"""

buy_template = """
<!doctype html>
<title>Buy Product</title>
<h1>Thanks for buying "{{ name }}" for ${{ price }}</h1>
<a href="/products">Back to Products</a>
"""

# Create or connect to SQLite database
def init_db():
    conn = sqlite3.connect('shop.db')
    c = conn.cursor()
    c.execute('''CREATE TABLE IF NOT EXISTS products
                 (id INTEGER PRIMARY KEY AUTOINCREMENT, name TEXT, price REAL)''')
    conn.commit()
    conn.close()

init_db()

# Routes
@app.route('/')
def home():
    return render_template_string(home_template)

@app.route('/products')
def products():
    conn = sqlite3.connect('shop.db')
    c = conn.cursor()
    c.execute("SELECT * FROM products")
    products = c.fetchall()
    conn.close()
    return render_template_string(products_template, products=products)

@app.route('/add', methods=['GET', 'POST'])
def add():
    if request.method == 'POST':
        name = request.form['name']
        price = float(request.form['price'])
        conn = sqlite3.connect('shop.db')
        c = conn.cursor()
        c.execute("INSERT INTO products (name, price) VALUES (?, ?)", (name, price))
        conn.commit()
        conn.close()
        return redirect(url_for('products'))
    return render_template_string(add_template)

@app.route('/buy/<int:product_id>')
def buy(product_id):
    conn = sqlite3.connect('shop.db')
    c = conn.cursor()
    c.execute("SELECT name, price FROM products WHERE id=?", (product_id,))
    product = c.fetchone()
    conn.close()
    if product:
        return render_template_string(buy_template, name=product[0], price=product[1])
    else:
        return "Product not found", 404

# Start the app in a thread (for Jupyter Notebook)
def run_app():
    app.run(debug=False, use_reloader=False)

# Launch in background
Thread(target=run_app).start()
