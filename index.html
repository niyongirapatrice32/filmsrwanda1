<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ðŸ“º Tube Promote Pro</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="module">
    // --- Firebase Init ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider } 
      from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, addDoc, query, onSnapshot } 
      from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "YOUR-API-KEY",
      authDomain: "YOUR-PROJECT.firebaseapp.com",
      projectId: "YOUR-PROJECT-ID",
      storageBucket: "YOUR-PROJECT.appspot.com",
      messagingSenderId: "YOUR-SENDER-ID",
      appId: "YOUR-APP-ID"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- Helpers ---
    const $ = id => document.getElementById(id);
    const tpl = html => { const t=document.createElement('template'); t.innerHTML=html; return t.content.firstChild; };
    let currentUser=null;

    // --- Auth ---
    const provider=new GoogleAuthProvider();
    $("loginBtn").onclick=()=>signInWithPopup(auth,provider);
    onAuthStateChanged(auth,async user=>{
      currentUser=user;
      $("user").innerText=user?`ðŸ‘¤ ${user.displayName}`:"Not logged in";
      if(user){
        await setDoc(doc(db,"users",user.uid),
          {name:user.displayName,email:user.email,earnings:0},{merge:true});
        loadEarnings();
      }
    });

    // --- Earnings ---
    async function loadEarnings(){
      if(!currentUser)return;
      const snap=await getDoc(doc(db,"users",currentUser.uid));
      $("earnings").innerText=snap.exists()?snap.data().earnings||0:0;
    }
    async function addEarnings(amount){
      if(!currentUser)return;
      const ref=doc(db,"users",currentUser.uid);
      const snap=await getDoc(ref);
      const val=(snap.data().earnings||0)+amount;
      await updateDoc(ref,{earnings:val});
      loadEarnings();
    }

    // --- Videos ---
    const videoList=$("videos");
    onSnapshot(collection(db,"videos"),snap=>{
      videoList.innerHTML="";
      snap.forEach(d=>{
        const v=d.data();
        const el=tpl(`
          <div class="p-4 shadow rounded bg-white relative">
            <iframe id="vid-${d.id}" class="w-full aspect-video" src="https://www.youtube.com/embed/${v.ytId}?enablejsapi=1"></iframe>
            <p class="mt-2 font-bold">${v.title}</p>
          </div>`);
        videoList.appendChild(el);
        // Timer tracking
        setupVideoTimer(`vid-${d.id}`);
      });
    });
    $("addVideo").onsubmit=e=>{
      e.preventDefault();
      addDoc(collection(db,"videos"),{
        ytId:$("ytId").value,title:$("ytTitle").value,uid:currentUser.uid,ts:Date.now()
      });
      $("ytId").value=""; $("ytTitle").value="";
    };

    // --- Video Timer with pause handling ---
    function setupVideoTimer(id){
      let timer=null,seconds=0;
      const iframe=$(`#${id}`);
      const onMsg=e=>{
        if(!e.data || !e.data.event)return;
        if(e.data.info?.playerState===1){ // playing
          if(!timer) timer=setInterval(()=>{seconds++; if(seconds%30===0) addEarnings(1);},1000);
        }else{ // paused or stopped
          clearInterval(timer); timer=null;
        }
      };
      window.addEventListener("message",onMsg);
      // inject API
      iframe.contentWindow.postMessage('{"event":"listening","id":1}','*');
    }

    // --- Floating Latest Video ---
    onSnapshot(query(collection(db,"videos")),snap=>{
      let latest=null;
      snap.forEach(d=>{ if(!latest||d.data().ts>latest.ts) latest={id:d.id,...d.data()}; });
      if(latest){
        $("floating").innerHTML=`<iframe class="w-64 aspect-video shadow-lg rounded" src="https://www.youtube.com/embed/${latest.ytId}" allowfullscreen></iframe>`;
      }
    });

    // --- Ideas ---
    const ideaList=$("ideas");
    onSnapshot(collection(db,"ideas"),snap=>{
      ideaList.innerHTML="";
      snap.forEach(d=> ideaList.appendChild(tpl(`<p class="p-2 bg-gray-100 rounded my-1">${d.data().text}</p>`)));
    });
    $("addIdea").onsubmit=e=>{
      e.preventDefault();
      addDoc(collection(db,"ideas"),{text:$("ideaText").value,uid:currentUser.uid});
      $("ideaText").value="";
    };

    // --- Contact ---
    $("contactForm").onsubmit=e=>{
      e.preventDefault();
      addDoc(collection(db,"contacts"),{message:$("msg").value,email:currentUser?.email||"anon"});
      $("msg").value=""; alert("Message sent!");
    };

    // --- Withdrawals ---
    const withdrawList=$("withdrawals");
    onSnapshot(collection(db,"withdrawals"),snap=>{
      withdrawList.innerHTML="";
      snap.forEach(d=> withdrawList.appendChild(tpl(`<p class="p-1">ðŸ’µ ${d.data().amount} RWF - ${d.data().status}</p>`)));
    });
    $("withdrawForm").onsubmit=e=>{
      e.preventDefault();
      const amt=Number($("amount").value);
      addDoc(collection(db,"withdrawals"),{uid:currentUser.uid,amount:amt,status:"pending"});
      $("amount").value="";
      alert("Withdrawal requested!");
    };
  </script>
</head>
<body class="p-4 space-y-6 bg-gray-50">
  <header class="flex justify-between items-center">
    <h1 class="text-xl font-bold">ðŸ“º Tube Promote Pro</h1>
    <button id="loginBtn" class="px-3 py-1 bg-blue-500 text-white rounded">Login</button>
    <span id="user"></span>
  </header>

  <div class="fixed bottom-4 right-4" id="floating"></div>

  <section>
    <h2 class="text-lg font-semibold">ðŸŽ¬ Videos</h2>
    <form id="addVideo" class="space-x-2 my-2">
      <input id="ytId" placeholder="YouTube ID" class="border p-1">
      <input id="ytTitle" placeholder="Title" class="border p-1">
      <button class="bg-green-500 text-white px-2 py-1 rounded">Add</button>
    </form>
    <div id="videos" class="grid md:grid-cols-2 gap-4 mt-3"></div>
  </section>

  <section>
    <h2 class="text-lg font-semibold">ðŸ’° Earnings</h2>
    <p>Balance: <span id="earnings">0</span> RWF</p>
    <form id="withdrawForm" class="space-x-2 mt-2">
      <input id="amount" type="number" placeholder="Amount" class="border p-1">
      <button class="bg-yellow-500 text-white px-2 py-1 rounded">Withdraw</button>
    </form>
    <div id="withdrawals" class="mt-2"></div>
  </section>

  <section>
    <h2 class="text-lg font-semibold">ðŸ’¡ Ideas</h2>
    <form id="addIdea" class="space-x-2">
      <input id="ideaText" placeholder="Share an idea..." class="border p-1 w-64">
      <button class="bg-purple-500 text-white px-2 py-1 rounded">Post</button>
    </form>
    <div id="ideas" class="mt-2"></div>
  </section>

  <section>
    <h2 class="text-lg font-semibold">ðŸ“© Contact</h2>
    <form id="contactForm" class="space-x-2">
      <input id="msg" placeholder="Message..." class="border p-1 w-64">
      <button class="bg-red-500 text-white px-2 py-1 rounded">Send</button>
    </form>
  </section>
</body>
      </html>
      
