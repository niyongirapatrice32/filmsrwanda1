import os
import sqlite3
from flask import (
    Flask, render_template, request,
    redirect, url_for, session, send_from_directory, flash
)
from werkzeug.utils import secure_filename

app = Flask(__name__)
app.secret_key = os.environ.get('SECRET_KEY', 'change_this_to_a_random_secret')

UPLOAD_FOLDER = os.path.join(app.root_path, 'static', 'uploads')
os.makedirs(UPLOAD_FOLDER, exist_ok=True)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
ALLOWED_EXTENSIONS = {'png', 'jpg', 'jpeg', 'gif'}

DATABASE = os.path.join(app.root_path, 'shop.db')


def allowed_file(filename):
    return '.' in filename and filename.rsplit('.', 1)[1].lower() in ALLOWED_EXTENSIONS


def get_db_connection():
    conn = sqlite3.connect(DATABASE)
    conn.row_factory = sqlite3.Row
    return conn


def init_db():
    conn = get_db_connection()
    c = conn.cursor()
    c.execute('''
        CREATE TABLE IF NOT EXISTS users (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            username TEXT UNIQUE NOT NULL,
            password TEXT NOT NULL,
            role TEXT CHECK(role IN ('buyer', 'seller')) NOT NULL
        )
    ''')
    c.execute('''
        CREATE TABLE IF NOT EXISTS products (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            name TEXT NOT NULL,
            price REAL NOT NULL,
            image TEXT,
            seller TEXT NOT NULL,
            FOREIGN KEY (seller) REFERENCES users(username)
        )
    ''')
    c.execute('''
        CREATE TABLE IF NOT EXISTS orders (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            product_id INTEGER NOT NULL,
            product_name TEXT NOT NULL,
            price REAL NOT NULL,
            buyer TEXT NOT NULL,
            FOREIGN KEY (buyer) REFERENCES users(username),
            FOREIGN KEY (product_id) REFERENCES products(id)
        )
    ''')
    conn.commit()
    conn.close()


@app.route('/')
def index():
    if 'username' in session:
        return render_template('home.html', username=session['username'], role=session['role'])
    return render_template('home.html', username=None)


@app.route('/register', methods=['GET', 'POST'])
def register():
    if request.method == 'POST':
        username = request.form['username'].strip()
        password = request.form['password']
        role = request.form['role']
        if role not in ('buyer', 'seller'):
            flash('Invalid role selected.')
            return redirect(url_for('register'))

        conn = get_db_connection()
        c = conn.cursor()
        try:
            c.execute(
                "INSERT INTO users (username, password, role) VALUES (?, ?, ?)",
                (username, password, role)
            )
            conn.commit()
            flash('Registration successful. Please log in.')
            return redirect(url_for('login'))
        except sqlite3.IntegrityError:
            flash('Username already exists.')
            return redirect(url_for('register'))
        finally:
            conn.close()
    return render_template('register.html')


@app.route('/login', methods=['GET', 'POST'])
def login():
    if request.method == 'POST':
        username = request.form['username'].strip()
        password = request.form['password']

        conn = get_db_connection()
        c = conn.cursor()
        c.execute("SELECT * FROM users WHERE username = ? AND password = ?", (username, password))
        user = c.fetchone()
        conn.close()

        if user:
            session['username'] = user['username']
            session['role'] = user['role']
            flash('Logged in successfully.')
            return redirect(url_for('index'))
        flash('Invalid username or password.')
        return redirect(url_for('login'))

    return render_template('login.html')


@app.route('/logout')
def logout():
    session.clear()
    flash('You have been logged out.')
    return redirect(url_for('index'))


@app.route('/products')
def products():
    conn = get_db_connection()
    products = conn.execute("SELECT * FROM products").fetchall()
    conn.close()
    return render_template('products.html', products=products)


@app.route('/uploads/<filename>')
def uploaded_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)


@app.route('/add_product', methods=['GET', 'POST'])
def add_product():
    if 'username' not in session or session.get('role') != 'seller':
        flash('Only sellers can add products.')
        return redirect(url_for('login'))

    if request.method == 'POST':
        name = request.form['name'].strip()
        price = request.form['price']
        image_file = request.files.get('image')
        filename = None

        if image_file and allowed_file(image_file.filename):
            filename = secure_filename(image_file.filename)
            image_file.save(os.path.join(app.config['UPLOAD_FOLDER'], filename))

        try:
            price_val = float(price)
        except ValueError:
            flash('Invalid price.')
            return redirect(url_for('add_product'))

        conn = get_db_connection()
        conn.execute(
            "INSERT INTO products (name, price, image, seller) VALUES (?, ?, ?, ?)",
            (name, price_val, filename, session['username'])
        )
        conn.commit()
        conn.close()
        flash('Product added successfully.')
        return redirect(url_for('products'))

    return render_template('add_product.html')


@app.route('/buy/<int:product_id>')
def buy(product_id):
    if 'username' not in session or session.get('role') != 'buyer':
        flash('Only buyers can purchase products.')
        return redirect(url_for('login'))

    conn = get_db_connection()
    product = conn.execute("SELECT * FROM products WHERE id = ?", (product_id,)).fetchone()

    if not product:
        conn.close()
        flash('Product not found.')
        return redirect(url_for('products'))

    conn.execute(
        "INSERT INTO orders (product_id, product_name, price, buyer) VALUES (?, ?, ?, ?)",
        (product['id'], product['name'], product['price'], session['username'])
    )
    conn.commit()
    conn.close()
    flash(f"Thanks for buying {product['name']} for ${product['price']:.2f}!")
    return redirect(url_for('products'))


@app.route('/orders')
def orders():
    if 'username' not in session:
        flash('You need to log in to see orders.')
        return redirect(url_for('login'))

    conn = get_db_connection()
    if session['role'] == 'buyer':
        orders = conn.execute("SELECT * FROM orders WHERE buyer = ?", (session['username'],)).fetchall()
        conn.close()
        return render_template('orders_buyer.html', orders=orders)
    elif session['role'] == 'seller':
        orders = conn.execute('''
            SELECT o.*
            FROM orders o
            JOIN products p ON o.product_id = p.id
            WHERE p.seller = ?
        ''', (session['username'],)).fetchall()
        conn.close()
        return render_template('orders_seller.html', orders=orders)

    conn.close()
    flash('Invalid user role.')
    return redirect(url_for('index'))


if __name__ == '__main__':
    init_db()
    app.run(debug=True)
